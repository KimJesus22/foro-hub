<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tópicos del Foro - ForoHub</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 2em; margin-bottom: 2em; }
        h1, h2 { color: #0d6efd; }
        .card-header { background-color: #0d6efd; color: white; }
        /* Evitar que el texto largo rompa la tabla */
        #tabla-topicos td {
            word-break: break-word;
        }
    </style>
</head>
<body>

<!-- Toast Container for notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">ForoHub</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <!-- Message will be inserted here -->
        </div>
    </div>
</div>

<div class="container">
    <h1 class="mb-4">Tópicos del Foro</h1>

    <!-- Tabla de Tópicos -->
    <div class="card mb-5">
        <div class="card-header">
            <h2>Tabla de Tópicos</h2>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="tabla-topicos" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Mensaje</th>
                            <th>Autor</th>
                            <th>Curso</th>
                            <th>Fecha de Creación</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Formulario para crear un nuevo tópico -->
    <div class="card">
        <div class="card-header">
            <h2>Crear Nuevo Tópico</h2>
        </div>
        <div class="card-body">
            <form id="form-crear-topico" class="needs-validation" novalidate>
                <!-- ... (resto del formulario sin cambios) ... -->
            </form>
        </div>
    </div>
</div>

<!-- jQuery, Bootstrap, DataTables JS... -->
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
    const API_URL = window.location.origin;
    let dataTable;
    let notificationToast;

    function showToast(message, isError = false) { /* ... (sin cambios) ... */ }

    async function fetchTopicos() {
        try {
            const response = await fetch(`${API_URL}/topicos`);
            if (!response.ok) throw new Error(`Error: ${response.statusText}`);
            const topicos = await response.json();

            // MODIFICADO: Añadir el campo 'mensaje' a los datos de la tabla
            const data = topicos.map(t => ([
                t.titulo,
                t.mensaje, // <-- MENSAJE AÑADIDO
                t.autor,
                t.curso,
                new Date(t.fechaCreacion).toLocaleString()
            ]));

            if (dataTable) {
                dataTable.clear().rows.add(data).draw();
            }

        } catch (err) {
            showToast(`No se pudieron cargar los tópicos: ${err.message}`, true);
        }
    }

    async function handleFormSubmit(event) { /* ... (sin cambios) ... */ }

    document.addEventListener('DOMContentLoaded', () => {
        dataTable = new DataTable('#tabla-topicos');
        notificationToast = new bootstrap.Toast(document.getElementById('notificationToast'));
        
        fetchTopicos();

        const form = document.getElementById('form-crear-topico');
        // Rellenar el formulario para que no se vea vacío
        form.innerHTML = `
            <div class="mb-3">
                <label for="jwt-token" class="form-label">Token JWT (Rol ADMIN requerido)</label>
                <input type="text" class="form-control" id="jwt-token" placeholder="Pega tu token de administrador aquí" required>
                <div class="invalid-feedback">Por favor, introduce un token JWT.</div>
            </div>
            <div class="mb-3">
                <label for="titulo" class="form-label">Título</label>
                <input type="text" class="form-control" id="titulo" required maxlength="100">
                <div class="invalid-feedback">El título es obligatorio.</div>
            </div>
            <div class="mb-3">
                <label for="mensaje" class="form-label">Mensaje</label>
                <textarea class="form-control" id="mensaje" rows="4" required maxlength="500"></textarea>
                <div class="invalid-feedback">El mensaje es obligatorio.</div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="autor" class="form-label">Autor</label>
                    <input type="text" class="form-control" id="autor" required>
                    <div class="invalid-feedback">El autor es obligatorio.</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="curso" class="form-label">Curso</label>
                    <input type="text" class="form-control" id="curso" required>
                    <div class="invalid-feedback">El curso es obligatorio.</div>
                </div>
            </div>
            <button class="btn btn-success btn-lg" type="submit">Crear Tópico</button>
        `;
        form.addEventListener('submit', handleFormSubmit);
    });

    // El resto de funciones (showToast, handleFormSubmit) se mantienen igual
    function showToast(message, isError = false) {
        const toastBody = notificationToast._element.querySelector('.toast-body');
        toastBody.textContent = message;
        if (isError) {
            notificationToast._element.classList.add('bg-danger', 'text-white');
            notificationToast._element.classList.remove('bg-success');
        } else {
            notificationToast._element.classList.add('bg-success', 'text-white');
            notificationToast._element.classList.remove('bg-danger');
        }
        notificationToast.show();
    }

    async function handleFormSubmit(event) {
        const form = event.target;
        event.preventDefault();
        event.stopPropagation();
        form.classList.add('was-validated');

        if (!form.checkValidity()) return;

        const token = document.getElementById('jwt-token').value;
        const postData = {
            titulo: document.getElementById('titulo').value,
            mensaje: document.getElementById('mensaje').value,
            autor: document.getElementById('autor').value,
            curso: document.getElementById('curso').value
        };

        try {
            const response = await fetch(`${API_URL}/topicos`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(postData)
            });

            if (response.status === 201) {
                showToast('¡Tópico creado con éxito!');
                form.reset();
                form.classList.remove('was-validated');
                fetchTopicos(); // Recargar la tabla
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message || `Error ${response.status}`);
            }
        } catch (err) {
            showToast(`Error al crear el tópico: ${err.message}`, true);
        }
    }
</script>

</body>
</html>
